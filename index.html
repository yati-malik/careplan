<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Care Dashboard - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f8fc; 
        }
        .dashboard-card {
            background-color: white;
            border-radius: 0.75rem; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), 0 2px 6px rgba(0, 0, 0, 0.03);
            padding: 1.5rem; 
            transition: all 0.3s ease-in-out;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.07), 0 4px 8px rgba(0, 0, 0, 0.04);
        }
        .status-badge {
            padding: 0.3rem 0.8rem; 
            border-radius: 9999px; 
            font-size: 0.7rem; 
            font-weight: 600; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .progress-bar-bg {
            background-color: #e9ecef; 
            border-radius: 9999px; 
            height: 0.75rem; 
            overflow: hidden;
        }
        .progress-bar-fill {
            background-image: linear-gradient(to right, #4f46e5, #7c3aed); 
            height: 100%;
            border-radius: 9999px; 
            transition: width 0.5s ease-in-out;
        }
        .icon-xs { width: 1rem; height: 1rem; }
        .icon-sm { width: 1.25rem; height: 1.25rem; }
        .icon-md { width: 1.5rem; height: 1.5rem; }
        .icon-lg { width: 2rem; height: 2rem; }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f7f8fc;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db; 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; 
        }

        .observation-value {
            font-weight: 700; 
            font-size: 1.125rem; 
        }
        .observation-range-normal { color: #10b981; }
        .observation-range-low { color: #f59e0b; }
        .observation-range-high { color: #ef4444; }
        .observation-range-critical { color: #dc2626; font-weight: 700;}

        .interactive-list-item {
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .interactive-list-item:hover {
            background-color: #f9fafb; 
            transform: translateX(2px);
        }
        .view-hidden {
            display: none !important;
        }
        .goal-item-link {
            display: block;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }
        .goal-item-link:hover {
            background-color: #f0f2f5;
        }
         /* Tab styling for Add Task View */
        .tab-button {
            padding: 0.75rem 1.5rem; /* Increased padding for better touch targets */
            border-bottom: 3px solid transparent; /* Thicker border for active state */
            font-weight: 600; /* Bolder font */
            color: #6b7280; /* gray-500 */
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            color: #4f46e5; /* indigo-600 */
            border-bottom-color: #a5b4fc; /* indigo-300 */
        }
        .tab-button.active {
            color: #4f46e5; /* indigo-600 */
            border-bottom-color: #4f46e5; /* indigo-600 */
        }
        .tab-content {
            padding-top: 1.5rem; /* More space below tabs */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex min-h-screen">
        <!-- Patient Drawer (Sidebar) -->
        <aside id="patientDrawer" class="w-80 bg-white shadow-xl p-6 fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 ease-in-out z-40 overflow-y-auto flex flex-col">
            <div>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-slate-800">Patient Panel</h2>
                    <button id="closeDrawerButton" aria-label="Close patient panel" class="text-slate-500 hover:text-slate-700 p-1 rounded-md hover:bg-slate-100">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="flex items-center space-x-4 mb-6">
                    <img src="https://placehold.co/80x80/E0E7FF/4338CA?text=YM" alt="Patient Avatar" class="w-20 h-20 rounded-full border-2 border-indigo-200">
                    <div>
                        <p class="text-lg font-bold text-indigo-700">Yati Malik</p>
                        <p class="text-sm text-slate-500">ID: P789012</p>
                        <p class="text-sm text-slate-500">DOB: 15 Aug 1994 (30 yrs)</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <p class="text-sm text-slate-500 pt-2">Last Visit: 12 May 2025</p>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div id="contentWrapper" class="flex-1 transition-all duration-300 ease-in-out">
            <!-- Header -->
            <header class="sticky top-0 bg-gray-100/80 backdrop-blur-lg shadow-sm p-4 md:p-6 z-30 flex items-center justify-between">
                <button id="openDrawerButton" aria-label="Open patient panel" class="text-slate-700 hover:text-indigo-600 p-2 -ml-2 rounded-md hover:bg-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                </button>
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-slate-800">Patient Care Dashboard</h1>
                <div>
                    <button aria-label="Notifications" class="p-2 text-slate-600 hover:text-indigo-600 rounded-full hover:bg-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
                        </svg>
                    </button>
                     <button aria-label="User Profile" class="ml-2 p-1 rounded-full hover:bg-slate-200">
                        <img src="https://placehold.co/32x32/C4B5FD/4338CA?text=AU" alt="User Avatar" class="w-8 h-8 rounded-full">
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <main class="p-4 md:p-6">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    
                    <!-- Middle Column for Dynamic Views -->
                    <div id="middleColumn" class="lg:col-span-7 xl:col-span-8">
                        <!-- Dashboard View -->
                        <div id="dashboardView" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Care Plan Summary Card -->
                            <div class="dashboard-card md:col-span-2 flex flex-col">
                                <h2 class="text-xl font-semibold text-slate-700 mb-4">Care Plan Summary</h2>
                                <div class="space-y-3 mb-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-slate-500">Start Date:</span>
                                        <span class="text-sm font-medium text-slate-700">19 May 2025</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-slate-500">Target Date:</span>
                                        <span class="text-sm font-medium text-slate-700">19 Dec 2025</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-slate-500">Status:</span>
                                        <span class="status-badge bg-green-100 text-green-700 border border-green-200">Active</span>
                                    </div>
                                </div>
                                <p class="text-sm text-slate-600 mb-auto leading-relaxed">
                                    This comprehensive care plan focuses on managing Eleanor's Type 2 Diabetes and Hypertension through a combination of medication adherence, lifestyle modifications (diet and exercise), and regular monitoring of key health indicators. The primary goals are to reduce HbA1c levels, maintain blood pressure within target ranges, and improve overall cardiovascular health. Additional focus on recent cognitive assessment.
                                </p>
                                <div class="pt-4 mt-4">
                                    <label for="plan-progress" class="text-sm font-medium text-slate-600 mb-1 block">Overall Progress (30%)</label>
                                    <div class="progress-bar-bg">
                                        <div class="progress-bar-fill" style="width: 30%;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Conditions and Orders Cards -->
                            <div class="dashboard-card md:col-span-2">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    <div>
                                        <div class="flex justify-between items-center mb-4">
                                            <h2 class="text-xl font-semibold text-slate-700">Conditions</h2>
                                            <button id="addConditionButton" class="ml-auto px-3 py-1 text-xs font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-colors flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                                                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                                                </svg>
                                                Add Condition
                                            </button>
                                        </div>
                                        <ul class="space-y-2 text-sm">
                                            <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100">Diabetes Mellitus Type 2 <span class="text-xs text-slate-400 block">(Chronic, Onset: 2010)</span></li>
                                            <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100">Hypertension <span class="text-xs text-slate-400 block">(Chronic, Onset: 2012)</span></li>
                                            <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100">Atherosclerosis <span class="text-xs text-slate-400 block">(Chronic)</span></li>
                                            <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100">Mild Cognitive Impairment <span class="text-xs text-slate-400 block">(New, Onset: 2024)</span></li>
                                        </ul>
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-4">
                                            <h2 class="text-xl font-semibold text-slate-700">Orders</h2>
                                            <button id="addOrderButton" class="ml-auto px-3 py-1 text-xs font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-colors flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                                                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                                                </svg>
                                                Add Order
                                            </button>
                                        </div>
                                        <ul class="space-y-2 text-sm">
                                            <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100 flex justify-between items-center">
                                                <span>Insulin Glargine</span> <span class="status-badge bg-blue-100 text-blue-700 border border-blue-200">Active</span>
                                            </li>
                                            <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100 flex justify-between items-center">
                                                <span>Liver Function Tests</span> <span class="status-badge bg-yellow-100 text-yellow-700 border border-yellow-200">Pending Results</span>
                                            </li>
                                            <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100 flex justify-between items-center">
                                                <span>Kidney Function Test</span> <span class="status-badge bg-green-100 text-green-700 border border-green-200">Completed</span>
                                            </li>
                                            <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100 flex justify-between items-center">
                                                <span>Blood Sugar Tests (HbA1c)</span> <span class="status-badge bg-blue-100 text-blue-700 border border-blue-200">Active</span>
                                            </li>
                                            <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100 flex justify-between items-center">
                                                <span>Lipid Profile</span> <span class="status-badge bg-gray-200 text-gray-700 border border-gray-300">Scheduled</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Current Observations Card -->
                            <div class="dashboard-card md:col-span-1 flex flex-col">
                                <h2 class="text-xl font-semibold text-slate-700 mb-4">Current Observations</h2>
                                <p class="text-xs text-slate-400 mb-3">Last Labs: 18 May 2025</p>
                                <div class="space-y-4">
                                    <div class="p-2.5 bg-slate-50 rounded-lg">
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-sm text-slate-600">Cholesterol</span>
                                            <span class="observation-value observation-range-high">240 <span class="text-xs font-normal">mg/dL</span></span>
                                        </div>
                                        <div class="mt-1 h-1.5 bg-red-200 rounded-full w-full"><div class="h-1.5 bg-red-500 rounded-full" style="width: 80%;"></div></div>
                                    </div>
                                    <div class="p-2.5 bg-slate-50 rounded-lg">
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-sm text-slate-600">LDL</span>
                                            <span class="observation-value observation-range-high">165 <span class="text-xs font-normal">mg/dL</span></span>
                                        </div>
                                        <div class="mt-1 h-1.5 bg-red-200 rounded-full w-full"><div class="h-1.5 bg-red-500 rounded-full" style="width: 75%;"></div></div>
                                    </div>
                                    <div class="p-2.5 bg-slate-50 rounded-lg">
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-sm text-slate-600">HDL</span>
                                            <span class="observation-value observation-range-low">35 <span class="text-xs font-normal">mg/dL</span></span>
                                        </div>
                                        <div class="mt-1 h-1.5 bg-amber-200 rounded-full w-full"><div class="h-1.5 bg-amber-500 rounded-full" style="width: 40%;"></div></div>
                                    </div>
                                     <div class="p-2.5 bg-slate-50 rounded-lg">
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-sm text-slate-600">HbA1c</span>
                                            <span class="observation-value observation-range-critical">7.8<span class="text-xs font-normal">%</span></span>
                                        </div>
                                        <div class="mt-1 h-1.5 bg-red-200 rounded-full w-full"><div class="h-1.5 bg-red-600 rounded-full" style="width: 85%;"></div></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Goal Expectations Card -->
                            <div class="dashboard-card md:col-span-1 flex flex-col">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-semibold text-slate-700">Goal Expectations</h2>
                                    <button id="addGoalButton" class="ml-auto px-3 py-1 text-xs font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-colors flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                                            <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                                        </svg>
                                        Add Goal
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    <a href="#view-goal-cholesterol" class="goal-item-link">
                                        <div class="flex justify-between items-center mb-1">
                                            <h3 class="text-md font-medium text-slate-700">Reduce Cholesterol</h3>
                                            <span class="text-xs text-slate-500">Target: &lt;180 mg/dL</span>
                                        </div>
                                        <div class="progress-bar-bg">
                                            <div class="progress-bar-fill bg-red-500" style="width: 80%;"></div>
                                        </div>
                                        <p class="text-xs text-slate-500 mt-1">Current: <span class="font-semibold">240 mg/dL</span></p>
                                    </a>
                                    <a href="#view-goal-liver" class="goal-item-link">
                                        <div class="flex justify-between items-center mb-1">
                                            <h3 class="text-md font-medium text-slate-700">Improve Liver Function</h3>
                                            <span class="text-xs text-slate-500">Target: Bilirubin &lt;1.2 mg/dL</span>
                                        </div>
                                        <div class="progress-bar-bg">
                                            <div class="progress-bar-fill bg-yellow-500" style="width: 60%;"></div>
                                        </div>
                                         <p class="text-xs text-slate-500 mt-1">Current Bilirubin: <span class="font-semibold">1.3 mg/dL</span></p>
                                    </a>
                                    <a href="#view-goal-bloodsugar" class="goal-item-link">
                                        <div class="flex justify-between items-center mb-1">
                                            <h3 class="text-md font-medium text-slate-700">Blood Sugar Control</h3>
                                            <span class="text-xs text-slate-500">Target: HbA1c &lt;7.0%</span>
                                        </div>
                                        <div class="progress-bar-bg">
                                            <div class="progress-bar-fill bg-red-500" style="width: 85%;"></div>
                                        </div>
                                         <p class="text-xs text-slate-500 mt-1">Current HbA1c: <span class="font-semibold">7.8%</span></p>
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Barriers to Care Card -->
                            <div class="dashboard-card md:col-span-2 flex flex-col"> 
                                <h2 class="text-xl font-semibold text-slate-700 mb-4">Barriers to Care</h2>
                                <ul class="space-y-3">
                                    <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100">
                                        <p class="text-sm font-medium text-slate-700">Insulin Resistance</p>
                                        <p class="text-xs text-slate-500">Tasks: Diet education, Metformin review</p>
                                    </li>
                                    <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100">
                                        <p class="text-sm font-medium text-slate-700">Weight Gain</p>
                                        <p class="text-xs text-slate-500">Tasks: Exercise plan, Calorie tracking</p>
                                    </li>
                                    <li class="interactive-list-item p-3 bg-slate-50 rounded-lg hover:bg-slate-100">
                                        <p class="text-sm font-medium text-slate-700">Occasional Alcohol Use</p>
                                        <p class="text-xs text-slate-500">Tasks: Counseling on alcohol limits</p>
                                    </li>
                                </ul>
                            </div>

                            <!-- Notes & Activity Log Card -->
                             <div class="dashboard-card md:col-span-2"> 
                                <h2 class="text-xl font-semibold text-slate-700 mb-4">Notes & Activity Log</h2>
                                <textarea id="careNotes" name="careNotes" rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow text-sm mb-3" placeholder="Enter new clinical note..."></textarea>
                                <div class="mt-1 text-right">
                                    <button class="px-5 py-2.5 text-sm font-medium text-white bg-slate-700 rounded-lg hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-1 transition-colors shadow-md hover:shadow-lg">
                                        Save Note
                                    </button>
                                </div>
                                <div class="mt-6 border-t border-slate-200 pt-4">
                                    <h3 class="text-md font-semibold text-slate-600 mb-3">Recent Patient Activity:</h3>
                                    <div class="space-y-3 max-h-40 overflow-y-auto">
                                        <div class="p-3 bg-slate-50 rounded-lg text-sm interactive-list-item">
                                            <p class="text-slate-700">Lab results (Potassium) reviewed by Dr. Sharma.</p>
                                            <p class="text-xs text-slate-400 mt-1">System Log - 19 May 2025, 09:15 AM</p>
                                        </div>
                                        <div class="p-3 bg-slate-50 rounded-lg text-sm interactive-list-item">
                                            <p class="text-slate-700">Patient reported increased fatigue. Advised to monitor blood sugar.</p>
                                            <p class="text-xs text-slate-400 mt-1">Dr. Anya Sharma - 15 May 2025, 10:30 AM</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Creation View -->
                        <div id="orderCreationView" class="view-hidden"> 
                            <div class="dashboard-card">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-semibold text-slate-800">Create New Order</h2>
                                    <button id="backToDashboardFromOrder" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-colors">
                                        Back to Dashboard
                                    </button>
                                </div>
                                <form id="createOrderForm">
                                    <div class="space-y-4">
                                        <div>
                                            <label for="orderType" class="block text-sm font-medium text-slate-700 mb-1">Order Type</label>
                                            <select id="orderType" name="orderType" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option>Lab Test</option>
                                                <option>Medication</option>
                                                <option>Imaging</option>
                                                <option>Referral</option>
                                                <option>Procedure</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="orderDetails" class="block text-sm font-medium text-slate-700 mb-1">Order Details</label>
                                            <textarea id="orderDetails" name="orderDetails" rows="3" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Complete Blood Count (CBC), Lisinopril 10mg, Chest X-Ray PA and Lateral..."></textarea>
                                        </div>
                                        <div>
                                            <label for="orderPriority" class="block text-sm font-medium text-slate-700 mb-1">Priority</label>
                                            <select id="orderPriority" name="orderPriority" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option>Routine</option>
                                                <option>Urgent</option>
                                                <option>STAT</option>
                                            </select>
                                        </div>
                                         <div>
                                            <label for="orderNotes" class="block text-sm font-medium text-slate-700 mb-1">Additional Notes (Optional)</label>
                                            <textarea id="orderNotes" name="orderNotes" rows="2" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Patient fasting status, specific instructions for referral..."></textarea>
                                        </div>
                                    </div>
                                    <div class="mt-6 text-right">
                                        <button type="button" id="cancelOrderButton" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-colors mr-2">
                                            Cancel
                                        </button>
                                        <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-colors shadow-md hover:shadow-lg">
                                            Submit Order
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Condition Creation View -->
                        <div id="conditionCreationView" class="view-hidden"> 
                            <div class="dashboard-card">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-semibold text-slate-800">Add New Condition</h2>
                                     <button id="backToDashboardFromCondition" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-colors">
                                        Back to Dashboard
                                    </button>
                                </div>
                                <form id="createConditionForm">
                                    <div class="space-y-4">
                                        <div>
                                            <label for="conditionName" class="block text-sm font-medium text-slate-700 mb-1">Condition Name / Code (SNOMED CT)</label>
                                            <input type="text" id="conditionName" name="conditionName" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Type 2 diabetes mellitus">
                                        </div>
                                        <div>
                                            <label for="conditionClinicalStatus" class="block text-sm font-medium text-slate-700 mb-1">Clinical Status</label>
                                            <select id="conditionClinicalStatus" name="conditionClinicalStatus" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option>Active</option>
                                                <option>Recurrence</option>
                                                <option>Relapse</option>
                                                <option>Inactive</option>
                                                <option>Remission</option>
                                                <option>Resolved</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="conditionVerificationStatus" class="block text-sm font-medium text-slate-700 mb-1">Verification Status</label>
                                            <select id="conditionVerificationStatus" name="conditionVerificationStatus" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option>Unconfirmed</option>
                                                <option>Provisional</option>
                                                <option>Differential</option>
                                                <option>Confirmed</option>
                                                <option>Refuted</option>
                                                <option>Entered in Error</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="conditionOnsetDate" class="block text-sm font-medium text-slate-700 mb-1">Onset Date (Approximate)</label>
                                            <input type="date" id="conditionOnsetDate" name="conditionOnsetDate" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                        <div>
                                            <label for="conditionSeverity" class="block text-sm font-medium text-slate-700 mb-1">Severity</label>
                                            <select id="conditionSeverity" name="conditionSeverity" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option>Mild</option>
                                                <option>Moderate</option>
                                                <option>Severe</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="conditionNotes" class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
                                            <textarea id="conditionNotes" name="conditionNotes" rows="3" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Diagnosed during routine check-up..."></textarea>
                                        </div>
                                    </div>
                                    <div class="mt-6 text-right">
                                        <button type="button" id="cancelConditionButton" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-colors mr-2">
                                            Cancel
                                        </button>
                                        <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-colors shadow-md hover:shadow-lg">
                                            Add Condition
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Goal Creation View -->
                        <div id="goalCreationView" class="view-hidden"> 
                            <div class="dashboard-card">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-semibold text-slate-800">Create New Goal</h2>
                                     <button id="backToDashboardFromGoal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-colors">
                                        Back to Dashboard
                                    </button>
                                </div>
                                <form id="createGoalForm">
                                    <div class="space-y-4">
                                        <div>
                                            <label for="goalDescription" class="block text-sm font-medium text-slate-700 mb-1">Description (e.g., Weight loss, A1c reduction)</label>
                                            <input type="text" id="goalDescription" name="goalDescription" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Describe the goal">
                                        </div>
                                        <div>
                                            <label for="goalLifecycleStatus" class="block text-sm font-medium text-slate-700 mb-1">Lifecycle Status</label>
                                            <select id="goalLifecycleStatus" name="goalLifecycleStatus" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="planned">Planned</option>
                                                <option value="accepted">Accepted</option>
                                                <option value="active" selected>Active</option>
                                                <option value="on-hold">On Hold</option>
                                            </select>
                                        </div>
                                         <div>
                                            <label for="goalCategory" class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                                            <select id="goalCategory" name="goalCategory" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option>Dietary</option>
                                                <option>Behavioral</option>
                                                <option>Treatment</option>
                                                <option>Physiotherapy</option>
                                                <option>Nursing</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="goalStartDate" class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                                            <input type="date" id="goalStartDate" name="goalStartDate" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                        <fieldset class="border p-4 rounded-md">
                                            <legend class="text-sm font-medium text-slate-700 px-1">Target Outcome</legend>
                                            <div class="space-y-3 mt-2">
                                                <div>
                                                    <label for="goalTargetMeasure" class="block text-xs font-medium text-slate-600 mb-1">Measure (e.g., Weight, HbA1c, Blood Pressure)</label>
                                                    <input type="text" id="goalTargetMeasure" name="goalTargetMeasure" class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Body Weight">
                                                </div>
                                                <div>
                                                    <label for="goalTargetDetailValue" class="block text-xs font-medium text-slate-600 mb-1">Target Value (e.g., 70 kg, <7%)</label>
                                                    <input type="text" id="goalTargetDetailValue" name="goalTargetDetailValue" class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 70 kg">
                                                </div>
                                                <div>
                                                    <label for="goalTargetDueDate" class="block text-xs font-medium text-slate-600 mb-1">Due Date (Optional)</label>
                                                    <input type="date" id="goalTargetDueDate" name="goalTargetDueDate" class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                </div>
                                            </div>
                                        </fieldset>
                                        
                                        <div class="mt-4 pt-4 border-t">
                                            <h3 class="text-md font-semibold text-slate-700 mb-2">Sub-Goals</h3>
                                            <div id="subGoalsDisplayContainer" class="space-y-2 mb-2">
                                                <!-- Dynamically added sub-goals will appear here -->
                                            </div>
                                            <button type="button" id="navigateToSubGoalFormButton" class="mt-2 px-3 py-1.5 text-xs font-medium text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                                                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                                                </svg>
                                                Add Sub-Goal
                                            </button>
                                        </div>

                                        <div>
                                            <label for="goalNotes" class="block text-sm font-medium text-slate-700 mb-1">Notes (Optional)</label>
                                            <textarea id="goalNotes" name="goalNotes" rows="2" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Additional details about the goal..."></textarea>
                                        </div>
                                    </div>
                                    <div class="mt-6 text-right">
                                        <button type="button" id="cancelGoalButton" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-colors mr-2">
                                            Cancel
                                        </button>
                                        <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-colors shadow-md hover:shadow-lg">
                                            Add Goal
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Goal Detail View -->
                        <div id="goalDetailView" class="view-hidden"> 
                            <div class="dashboard-card">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-semibold text-slate-800">Goal Details</h2>
                                    <button id="backToDashboardFromGoalDetail" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-colors">
                                        Back to Dashboard
                                    </button>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <h3 class="text-sm font-medium text-slate-500">Description</h3>
                                        <p id="viewGoalDescription" class="text-lg text-slate-800"></p>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <h3 class="text-sm font-medium text-slate-500">Lifecycle Status</h3>
                                            <p id="viewGoalLifecycleStatus" class="text-slate-700"></p>
                                        </div>
                                        <div>
                                            <h3 class="text-sm font-medium text-slate-500">Category</h3>
                                            <p id="viewGoalCategory" class="text-slate-700"></p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <h3 class="text-sm font-medium text-slate-500">Start Date</h3>
                                            <p id="viewGoalStartDate" class="text-slate-700"></p>
                                        </div>
                                        <div>
                                            <h3 class="text-sm font-medium text-slate-500">Target Due Date</h3>
                                            <p id="viewGoalTargetDueDate" class="text-slate-700"></p>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="text-sm font-medium text-slate-500">Target Outcome</h3>
                                        <p id="viewGoalTargetMeasure" class="text-slate-700"></p>
                                        <p id="viewGoalTargetDetailValue" class="text-lg font-semibold text-indigo-600"></p>
                                    </div>
                                    <div>
                                        <h3 class="text-sm font-medium text-slate-500">Notes</h3>
                                        <p id="viewGoalNotes" class="text-slate-700 whitespace-pre-wrap"></p>
                                    </div>

                                    <div class="mt-6 pt-4 border-t border-slate-200">
                                        <div class="flex justify-between items-center mb-3">
                                            <h3 class="text-lg font-semibold text-slate-700">Breakdown</h3>
                                            <button id="addSubGoalToDetailViewButton" class="px-3 py-1.5 text-xs font-medium text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                                                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                                                </svg>
                                                Add Sub-Goal
                                            </button>
                                        </div>
                                        <div id="viewGoalBreakdownContainer" class="space-y-3">
                                            <!-- Dynamically populated sub-goals and tasks -->
                                        </div>
                                    </div>

                                     <div class="mt-6 text-right">
                                        <button type="button" id="editGoalButton" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-colors shadow-md hover:shadow-lg">
                                            Edit Goal
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Goal Edit View -->
                        <div id="goalEditView" class="view-hidden">
                            <div class="dashboard-card">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-semibold text-slate-800">Edit Goal</h2>
                                    <button id="backToGoalDetailFromEdit" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-colors">
                                        Cancel
                                    </button>
                                </div>
                                <form id="editGoalForm">
                                    <input type="hidden" id="editGoalId" name="editGoalId">
                                    <div class="space-y-4">
                                        <div>
                                            <label for="editGoalDescription" class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                                            <input type="text" id="editGoalDescription" name="editGoalDescription" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                        <div>
                                            <label for="editGoalLifecycleStatus" class="block text-sm font-medium text-slate-700 mb-1">Lifecycle Status</label>
                                            <select id="editGoalLifecycleStatus" name="editGoalLifecycleStatus" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="planned">Planned</option>
                                                <option value="accepted">Accepted</option>
                                                <option value="active">Active</option>
                                                <option value="on-hold">On Hold</option>
                                                <option value="completed">Completed</option>
                                                <option value="cancelled">Cancelled</option>
                                                <option value="entered-in-error">Entered in Error</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="editGoalCategory" class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                                            <select id="editGoalCategory" name="editGoalCategory" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option>Dietary</option>
                                                <option>Behavioral</option>
                                                <option>Treatment</option>
                                                <option>Physiotherapy</option>
                                                <option>Nursing</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="editGoalStartDate" class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                                            <input type="date" id="editGoalStartDate" name="editGoalStartDate" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                        <fieldset class="border p-4 rounded-md">
                                            <legend class="text-sm font-medium text-slate-700 px-1">Target Outcome</legend>
                                            <div class="space-y-3 mt-2">
                                                <div>
                                                    <label for="editGoalTargetMeasure" class="block text-xs font-medium text-slate-600 mb-1">Measure</label>
                                                    <input type="text" id="editGoalTargetMeasure" name="editGoalTargetMeasure" class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                </div>
                                                <div>
                                                    <label for="editGoalTargetDetailValue" class="block text-xs font-medium text-slate-600 mb-1">Target Value</label>
                                                    <input type="text" id="editGoalTargetDetailValue" name="editGoalTargetDetailValue" class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                </div>
                                                <div>
                                                    <label for="editGoalTargetDueDate" class="block text-xs font-medium text-slate-600 mb-1">Due Date (Optional)</label>
                                                    <input type="date" id="editGoalTargetDueDate" name="editGoalTargetDueDate" class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                </div>
                                            </div>
                                        </fieldset>
                                        
                                        <div class="mt-4 pt-4 border-t">
                                            <h3 class="text-md font-semibold text-slate-700 mb-2">Sub-Goals</h3>
                                            <div id="editSubGoalsDisplayContainer" class="space-y-2 mb-2">
                                                <!-- Dynamically added/edited sub-goals will appear here -->
                                            </div>
                                            <button type="button" id="navigateToSubGoalFormButtonFromEdit" class="mt-2 px-3 py-1.5 text-xs font-medium text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                                                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                                                </svg>
                                                Add Sub-Goal
                                            </button>
                                        </div>

                                        <div>
                                            <label for="editGoalNotes" class="block text-sm font-medium text-slate-700 mb-1">Notes (Optional)</label>
                                            <textarea id="editGoalNotes" name="editGoalNotes" rows="2" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                        </div>
                                    </div>
                                    <div class="mt-6 text-right">
                                        <button type="button" id="cancelGoalEditButton" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-colors mr-2">
                                            Cancel
                                        </button>
                                        <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-colors shadow-md hover:shadow-lg">
                                            Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>


                        <!-- Add Sub-Goal View -->
                        <div id="addSubGoalView" class="view-hidden"> 
                            <div class="dashboard-card">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-semibold text-slate-800">Add Sub-Goal</h2>
                                    <button id="backToParentFromSubGoal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-colors">
                                        Back
                                    </button>
                                </div>
                                <form id="createSubGoalForm">
                                    <div class="space-y-4">
                                        <div>
                                            <label for="subGoalDescription" class="block text-sm font-medium text-slate-700 mb-1">Sub-Goal Description</label>
                                            <input type="text" id="subGoalDescription" name="subGoalDescription" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Describe the sub-goal">
                                        </div>
                                        <div>
                                            <label for="subGoalTarget" class="block text-sm font-medium text-slate-700 mb-1">Sub-Goal Target (Optional)</label>
                                            <input type="text" id="subGoalTarget" name="subGoalTarget" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Walk 30 minutes daily">
                                        </div>
                                        <div class="mt-4 pt-4 border-t">
                                            <h3 class="text-md font-semibold text-slate-700 mb-2">Tasks for this Sub-Goal</h3>
                                            <div id="tasksForSubGoalContainer" class="space-y-2 mb-2">
                                                 <!-- Dynamically added tasks will appear here -->
                                            </div>
                                            <button type="button" id="navigateToTaskFormButton" class="mt-2 px-3 py-1.5 text-xs font-medium text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex items-center">
                                                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                                                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                                                </svg>
                                                Add New Task
                                            </button>
                                        </div>
                                        <div class="mt-4 pt-4 border-t">
                                            <h3 class="text-md font-semibold text-slate-700 mb-2">Link Existing Task</h3>
                                            <div class="flex space-x-2 mb-2">
                                                <input type="text" id="taskSearchInputSubGoal" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search existing tasks...">
                                                <button type="button" id="taskSearchButtonSubGoal" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Search</button>
                                            </div>
                                            <div id="taskSearchResultsContainerSubGoal" class="max-h-40 overflow-y-auto space-y-1">
                                                <!-- Task search results -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-6 text-right">
                                        <button type="button" id="cancelSubGoalButton" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-colors mr-2">
                                            Cancel Sub-Goal
                                        </button>
                                        <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-colors shadow-md hover:shadow-lg">
                                            Save Sub-Goal
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Add/Link Task View -->
                        <div id="addTaskView" class="view-hidden"> 
                            <div class="dashboard-card">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-semibold text-slate-800">Task Management</h2>
                                    <button id="backToParentFromTask" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-colors">
                                        Back
                                    </button>
                                </div>
                        
                                <div class="mb-4 border-b border-gray-200">
                                    <nav id="taskFormTabs" class="-mb-px flex space-x-1" aria-label="Tabs">
                                        <button data-tab="create-task" class="tab-button active">Create New Task</button>
                                        <button data-tab="link-task" class="tab-button">Link Existing Task</button>
                                    </nav>
                                </div>
                        
                                <div id="createTaskFormSection" class="tab-content">
                                    <form id="createTaskForm">
                                        <div class="space-y-4">
                                            <div>
                                                <label for="taskDescription" class="block text-sm font-medium text-slate-700 mb-1">Task Description</label>
                                                <input type="text" id="taskDescription" name="taskDescription" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Describe the task">
                                            </div>
                                            <div>
                                                <label for="taskStatus" class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                                                <select id="taskStatus" name="taskStatus" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                    <option value="draft">Draft</option>
                                                    <option value="requested">Requested</option>
                                                    <option value="received">Received</option>
                                                    <option value="accepted">Accepted</option>
                                                    <option value="in-progress" selected>In Progress</option>
                                                    <option value="completed">Completed</option>
                                                    <option value="failed">Failed</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="taskPriority" class="block text-sm font-medium text-slate-700 mb-1">Priority</label>
                                                <select id="taskPriority" name="taskPriority" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                    <option value="routine">Routine</option>
                                                    <option value="urgent">Urgent</option>
                                                    <option value="asap">ASAP</option>
                                                    <option value="stat">STAT</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="taskOwner" class="block text-sm font-medium text-slate-700 mb-1">Assignee (Owner)</label>
                                                <input type="text" id="taskOwner" name="taskOwner" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Nurse Jane Doe, Patient Self">
                                            </div>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label for="taskStartDate" class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                                                    <input type="date" id="taskStartDate" name="taskStartDate" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                </div>
                                                <div>
                                                    <label for="taskEndDate" class="block text-sm font-medium text-slate-700 mb-1">End Date (Optional)</label>
                                                    <input type="date" id="taskEndDate" name="taskEndDate" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                </div>
                                            </div>
                                            <div>
                                                <label for="taskNotes" class="block text-sm font-medium text-slate-700 mb-1">Notes (Optional)</label>
                                                <textarea id="taskNotes" name="taskNotes" rows="2" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Additional details about the task..."></textarea>
                                            </div>
                                        </div>
                                        <div class="mt-6 text-right">
                                            <button type="button" id="cancelTaskButton" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-colors mr-2">
                                                Cancel Task
                                            </button>
                                            <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-colors shadow-md hover:shadow-lg">
                                                Add Task
                                            </button>
                                        </div>
                                    </form>
                                </div>
                        
                                <div id="linkTaskFormSection" class="tab-content view-hidden">
                                    <div class="flex space-x-2 mb-2">
                                        <input type="text" id="taskManagementSearchInput" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search existing tasks...">
                                        <button type="button" id="taskManagementSearchButton" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Search</button>
                                    </div>
                                    <div id="taskManagementSearchResults" class="max-h-60 overflow-y-auto space-y-1">
                                        <!-- Task search results for linking -->
                                    </div>
                                     <div id="taskManagementCreateNewButtonContainer" class="mt-3">
                                        <!-- Button to switch to create new task if not found -->
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div> 
                    
                    <!-- Right Sidebar Column -->
                    <div id="rightSidebarColumn" class="lg:col-span-5 xl:col-span-4 flex flex-col space-y-6">
                        <!-- Need Attention Card -->
                        <div class="dashboard-card bg-rose-50 border border-rose-200 flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-rose-700">Need Attention (3)</h2>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon-md text-rose-600">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.249-8.25-3.286zm0 13.036h.008v.008H12v-.008z" />
                                </svg>
                            </div>
                            <ul class="space-y-3">
                                <li class="interactive-list-item flex items-start p-3 bg-white rounded-lg shadow-sm border border-red-300 hover:border-red-400">
                                    <span class="p-1.5 bg-red-100 rounded-full mr-3 mt-0.5 flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon-xs text-red-600">
                                          <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                        </svg>
                                    </span>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium text-sm text-red-700 truncate">Critical Lab: Potassium 5.8 mEq/L</p>
                                        <p class="text-xs text-slate-500">Flagged: 1 hour ago by System</p>
                                    </div>
                                    <button class="ml-2 px-3 py-1 text-xs font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1 transition-colors flex-shrink-0">Review</button>
                                </li>
                                <li class="interactive-list-item flex items-start p-3 bg-white rounded-lg shadow-sm border border-amber-300 hover:border-amber-400">
                                    <span class="p-1.5 bg-amber-100 rounded-full mr-3 mt-0.5 flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon-xs text-amber-600">
                                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" />
                                    </svg>
                                    </span>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium text-sm text-amber-700 truncate">Medication Refill Due: Atorvastatin</p>
                                        <p class="text-xs text-slate-500">Due: Tomorrow</p>
                                    </div>
                                     <button class="ml-2 px-3 py-1 text-xs font-medium text-white bg-amber-500 rounded-md hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-amber-400 focus:ring-offset-1 transition-colors flex-shrink-0">Process</button>
                                </li>
                                 <li class="interactive-list-item flex items-start p-3 bg-white rounded-lg shadow-sm border border-blue-300 hover:border-blue-400">
                                     <span class="p-1.5 bg-blue-100 rounded-full mr-3 mt-0.5 flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon-xs text-blue-600">
                                      <path d="M3.5 4A1.5 1.5 0 002 5.5v9A1.5 1.5 0 003.5 16h13a1.5 1.5 0 001.5-1.5v-9A1.5 1.5 0 0016.5 4h-13zM12 7a1 1 0 011 1v1a1 1 0 11-2 0V8a1 1 0 011-1zm-3 2a1 1 0 100-2 1 1 0 000 2zM8 7a1 1 0 011 1v1a1 1 0 11-2 0V8a1 1 0 011-1zm5 4a1 1 0 100-2 1 1 0 000 2zM7 12a1 1 0 11-2 0 1 1 0 012 0zm3 1a1 1 0 100-2 1 1 0 000 2z" />
                                      <path d="M2.5 18a.5.5 0 000 1h15a.5.5 0 000-1h-15z" />
                                    </svg>
                                    </span>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium text-sm text-blue-700 truncate">Unread Message from Patient</p>
                                        <p class="text-xs text-slate-500">Received: 2 hours ago</p>
                                    </div>
                                     <button class="ml-2 px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 transition-colors flex-shrink-0">View</button>
                                </li>
                            </ul>
                        </div>
                        <!-- Care Plan Suggestions Card -->
                         <div class="dashboard-card bg-sky-50 border border-sky-200 flex flex-col">
                            <h2 class="text-xl font-semibold text-sky-700 mb-4">Care Plan Suggestions</h2>
                            <div class="space-y-3">
                                <div class="p-3 bg-white rounded-lg shadow-sm border border-sky-200 hover:border-sky-300 flex flex-col sm:flex-row justify-between sm:items-center interactive-list-item">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-sky-800">Consider SGLT2 inhibitor for diabetes & CVD risk.</p>
                                        <p class="text-xs text-slate-500"><span class="font-semibold text-sky-600">Priority: High</span> | Rationale: High HbA1c, Atherosclerosis.</p>
                                    </div>
                                    <button class="mt-2 sm:mt-0 sm:ml-4 px-4 py-2 text-xs font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-all duration-150 ease-in-out shadow-md hover:shadow-lg flex-shrink-0">
                                        Add to Plan
                                    </button>
                                </div>
                                <div class="p-3 bg-white rounded-lg shadow-sm border border-sky-200 hover:border-sky-300 flex flex-col sm:flex-row justify-between sm:items-center interactive-list-item">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-sky-800">Refer to dietitian for personalized meal planning.</p>
                                        <p class="text-xs text-slate-500"><span class="font-semibold text-sky-600">Priority: Medium</span> | Rationale: Irregular meals, weight gain.</p>
                                    </div>
                                    <button class="mt-2 sm:mt-0 sm:ml-4 px-4 py-2 text-xs font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-all duration-150 ease-in-out shadow-md hover:shadow-lg flex-shrink-0">
                                        Create Referral
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div> 
                </div> 
            </main>
        </div> 
    </div> 
    
    <!-- Drawer Overlay for mobile -->
    <div id="drawerOverlay" class="fixed inset-0 bg-black bg-opacity-30 z-30 hidden"></div>

    <script>
        // DOM Element References
        const patientDrawer = document.getElementById('patientDrawer');
        const openDrawerButton = document.getElementById('openDrawerButton');
        const closeDrawerButton = document.getElementById('closeDrawerButton');
        const contentWrapper = document.getElementById('contentWrapper'); 
        const drawerOverlay = document.getElementById('drawerOverlay');

        // Main View Containers
        const middleColumn = document.getElementById('middleColumn');
        const dashboardView = document.getElementById('dashboardView');
        const orderCreationView = document.getElementById('orderCreationView');
        const conditionCreationView = document.getElementById('conditionCreationView');
        const goalCreationView = document.getElementById('goalCreationView');
        const goalDetailView = document.getElementById('goalDetailView');
        const goalEditView = document.getElementById('goalEditView'); // New Edit View
        const addSubGoalView = document.getElementById('addSubGoalView');
        const addTaskView = document.getElementById('addTaskView');
        
        // Button References for Adding/Navigating
        const addOrderBtn = document.getElementById('addOrderButton');
        const addConditionBtn = document.getElementById('addConditionButton');
        const addGoalBtn = document.getElementById('addGoalButton');
        const editGoalButtonOnDetailView = document.getElementById('editGoalButton'); // Button on Goal Detail to go to Edit View
        const navigateToSubGoalFormButton = document.getElementById('navigateToSubGoalFormButton'); // In Goal Creation
        const navigateToSubGoalFormButtonFromEdit = document.getElementById('navigateToSubGoalFormButtonFromEdit'); // In Goal Edit
        const navigateToTaskFormButton = document.getElementById('navigateToTaskFormButton'); // In Sub-Goal Creation
        const addSubGoalToDetailViewButton = document.getElementById('addSubGoalToDetailViewButton'); // In Goal Detail
        
        // References for Sub-Goal and Task elements within forms
        const subGoalsDisplayContainer = document.getElementById('subGoalsDisplayContainer'); // In Goal Creation
        const editSubGoalsDisplayContainer = document.getElementById('editSubGoalsDisplayContainer'); // In Goal Edit
        const tasksForSubGoalContainer = document.getElementById('tasksForSubGoalContainer'); // In Sub-Goal Creation
        const taskSearchInputSubGoal = document.getElementById('taskSearchInputSubGoal'); 
        const taskSearchButtonSubGoal = document.getElementById('taskSearchButtonSubGoal'); 
        const taskSearchResultsContainerSubGoal = document.getElementById('taskSearchResultsContainerSubGoal'); 

        // References for Task Management View (Tabs, Search, etc.)
        const taskManagementSearchInput = document.getElementById('taskManagementSearchInput');
        const taskManagementSearchButton = document.getElementById('taskManagementSearchButton');
        const taskManagementSearchResults = document.getElementById('taskManagementSearchResults');
        const taskManagementCreateNewButtonContainer = document.getElementById('taskManagementCreateNewButtonContainer');
        const taskFormTabs = document.getElementById('taskFormTabs');
        const createTaskFormSection = document.getElementById('createTaskFormSection');
        const linkTaskFormSection = document.getElementById('linkTaskFormSection');

        // Back/Cancel Button References
        const backToDashboardFromOrderBtn = document.getElementById('backToDashboardFromOrder');
        const cancelOrderBtn = document.getElementById('cancelOrderButton');
        const backToDashboardFromConditionBtn = document.getElementById('backToDashboardFromCondition');
        const cancelConditionBtn = document.getElementById('cancelConditionButton');
        const backToDashboardFromGoalBtn = document.getElementById('backToDashboardFromGoal'); // From Goal Creation
        const cancelGoalBtn = document.getElementById('cancelGoalButton'); // From Goal Creation
        const backToDashboardFromGoalDetailBtn = document.getElementById('backToDashboardFromGoalDetail');
        const backToGoalDetailFromEditBtn = document.getElementById('backToGoalDetailFromEdit'); // From Goal Edit (Cancel)
        const cancelGoalEditBtn = document.getElementById('cancelGoalEditButton'); // From Goal Edit (Alternative Cancel)
        const backToParentFromSubGoalBtn = document.getElementById('backToParentFromSubGoal'); // From Sub-Goal Creation
        const cancelSubGoalBtn = document.getElementById('cancelSubGoalButton'); // From Sub-Goal Creation
        const backToParentFromTaskBtn = document.getElementById('backToParentFromTask'); // From Task Creation
        const cancelTaskBtn = document.getElementById('cancelTaskButton'); // From Task Creation

        // Temporary data stores
        let tempSubGoals = []; // For new goal creation or editing existing goal's subgoals
        let tempTasksForSubGoal = []; // For new sub-goal creation or editing existing sub-goal's tasks
        let currentViewingGoalId = null; // ID of the goal being viewed or edited
        let currentEditingGoalId = null; // Specifically for the edit view context
        // let currentParentGoalForSubGoal = null; // Not strictly needed as goalId is passed in hash
        // let currentParentSubGoalForTask = null; // Not strictly needed as subGoalId is passed in hash

        // Mock Data (Simulates backend data)
        const existingTasksData = [
            { id: "task_existing_1", description: "Review medication adherence quarterly", status: "planned", priority: "routine", owner: "Pharmacist"},
            { id: "task_existing_2", description: "Schedule follow-up appointment in 3 months", status: "requested", priority: "routine", owner: "Scheduler"},
            { id: "task_existing_3", description: "Educate patient on home blood pressure monitoring", status: "in-progress", priority: "medium", owner: "Nurse Educator"},
            { id: "task_existing_4", description: "Perform annual foot exam", status: "planned", priority: "routine", owner: "Podiatrist"},
        ];

        let goalsData = { // Changed to let for modification
            cholesterol: {
                id: "cholesterol",
                description: "Reduce Cholesterol",
                lifecycleStatus: "Active",
                category: "Dietary",
                startDate: "2025-05-20",
                targetMeasure: "Total Cholesterol",
                targetDetailValue: "< 180 mg/dL",
                targetDueDate: "2025-12-19",
                notes: "Focus on low-fat diet and increased physical activity. Monitor lipid panel quarterly.",
                subGoals: [
                    { 
                        id: "cholesterol-sub1",
                        description: "Dietary Adjustments for Cholesterol", 
                        status: "In Progress", 
                        target: "Reduce daily caloric intake by 500 kcal.",
                        tasks: [
                            { id: "task1_1", description: "Track daily food intake using a journal.", completed: true, status: "completed", priority: "routine", owner: "Patient" },
                            { id: "task1_2", description: "Consult with dietitian for meal plan.", completed: false, status: "in-progress", priority: "medium", owner: "Nurse"}
                        ]
                    },
                    { 
                        id: "cholesterol-sub2",
                        description: "Increase Omega-3 Intake", 
                        status: "Planned", 
                        target: "Consume fatty fish twice a week.",
                        tasks: [
                            { id: "task_c_s2_t1", description: "Research Omega-3 rich fish.", completed: false, status: "planned", priority: "low", owner: "Patient" },
                            { id: "task_c_s2_t2", description: "Add fish to weekly shopping list.", completed: false, status: "planned", priority: "low", owner: "Patient" }
                        ]
                    }
                ]
            },
            liver: {
                id: "liver",
                description: "Improve Liver Function",
                lifecycleStatus: "Active",
                category: "Medical",
                startDate: "2025-05-20",
                targetMeasure: "Total Bilirubin",
                targetDetailValue: "< 1.2 mg/dL",
                targetDueDate: "2025-08-20",
                notes: "Monitor liver enzymes and bilirubin levels. Avoid hepatotoxic medications.",
                subGoals: [] 
            },
            bloodsugar: {
                id: "bloodsugar",
                description: "Blood Sugar Control",
                lifecycleStatus: "Active",
                category: "Medical Management",
                startDate: "2025-01-15",
                targetMeasure: "HbA1c",
                targetDetailValue: "< 7.0%",
                targetDueDate: "2025-07-15",
                notes: "Adherence to diabetic diet, regular glucose monitoring, and prescribed medications.",
                subGoals: [
                     { 
                        id: "bloodsugar-sub1",
                        description: "Increase Physical Activity", 
                        status: "Planned", 
                        target: "30 minutes of moderate exercise, 5 days a week.",
                        tasks: [
                            { id: "task_bs_s1_t1", description: "Schedule daily walks.", completed: false, status: "planned", priority: "routine", owner: "Patient" },
                            { id: "task_bs_s1_t2", description: "Join a local fitness group.", completed: false, status: "planned", priority: "low", owner: "Patient" }
                        ]
                    }
                ]
            }
        };

        // Function to render sub-goals in either Goal Creation or Goal Edit view
        function renderSubGoalsInForm(subGoalsArray, containerElement, isEditMode = false, parentGoalId = null) {
            containerElement.innerHTML = '';
            subGoalsArray.forEach((subGoal, index) => {
                const subGoalDiv = document.createElement('div');
                subGoalDiv.className = 'p-3 border rounded-md bg-slate-100 text-sm mb-2';
                
                let tasksHtml = '<ul class="list-disc list-inside ml-4 mt-1 text-xs">';
                if (subGoal.tasks && subGoal.tasks.length > 0) {
                    subGoal.tasks.forEach(task => {
                        tasksHtml += `<li>${task.description} ${task.isExisting ? '(Linked)' : '(New)'}</li>`;
                    });
                } else {
                    tasksHtml += '<li>No tasks defined.</li>';
                }
                tasksHtml += '</ul>';

                subGoalDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${subGoal.description}</span>
                        <div>
                            ${isEditMode ? `<button type="button" class="editTempSubGoalButton text-blue-600 hover:text-blue-800 text-xs mr-2" data-index="${index}" data-parent-goal-id="${parentGoalId}">Edit</button>` : ''}
                            <button type="button" class="removeTempSubGoalButton text-red-500 hover:text-red-700 text-xs" data-index="${index}">Remove</button>
                        </div>
                    </div>
                    <p class="text-xs text-slate-600">Target: ${subGoal.target || 'N/A'}</p>
                    ${tasksHtml}
                `;
                containerElement.appendChild(subGoalDiv);
            });

            // Add event listeners for remove buttons (and edit if in edit mode)
            containerElement.querySelectorAll('.removeTempSubGoalButton').forEach(button => {
                button.addEventListener('click', function() {
                    const indexToRemove = parseInt(this.dataset.index);
                    tempSubGoals.splice(indexToRemove, 1);
                    renderSubGoalsInForm(tempSubGoals, containerElement, isEditMode, parentGoalId); // Re-render
                });
            });

            if (isEditMode) {
                containerElement.querySelectorAll('.editTempSubGoalButton').forEach(button => {
                    button.addEventListener('click', function() {
                        const indexToEdit = parseInt(this.dataset.index);
                        const subGoalToEdit = tempSubGoals[indexToEdit];
                        // Navigate to addSubGoalView, but pre-fill it and change its mode to "edit"
                        // This part needs careful implementation if deep editing of sub-goals is required here.
                        // For now, let's assume "edit" means removing and re-adding.
                        // A more robust solution would involve a dedicated sub-goal edit view or modal.
                        console.log("Edit sub-goal at index:", indexToEdit, subGoalToEdit);
                        alert("Editing sub-goals directly in this list is not fully implemented. Please remove and re-add if changes are needed for sub-goal structure or its tasks.");
                        // Example navigation for a future enhancement:
                        // window.location.hash = `#edit-sub-goal?parentGoalId=${parentGoalId}&subGoalIndex=${indexToEdit}&from=goalEdit`;
                    });
                });
            }
        }


        // Function to populate the Goal Detail View
        function populateGoalDetailView(goalId) {
            currentViewingGoalId = goalId; 
            const goal = goalsData[goalId];
            if (goal) {
                document.getElementById('viewGoalDescription').textContent = goal.description;
                document.getElementById('viewGoalLifecycleStatus').textContent = goal.lifecycleStatus;
                document.getElementById('viewGoalCategory').textContent = goal.category;
                document.getElementById('viewGoalStartDate').textContent = goal.startDate;
                document.getElementById('viewGoalTargetDueDate').textContent = goal.targetDueDate || 'N/A';
                document.getElementById('viewGoalTargetMeasure').textContent = goal.targetMeasure;
                document.getElementById('viewGoalTargetDetailValue').textContent = goal.targetDetailValue;
                document.getElementById('viewGoalNotes').textContent = goal.notes || 'No additional notes.';

                const breakdownContainer = document.getElementById('viewGoalBreakdownContainer');
                breakdownContainer.innerHTML = ''; 

                if (goal.subGoals && goal.subGoals.length > 0) {
                    goal.subGoals.forEach(subGoal => {
                        const subGoalDiv = document.createElement('div');
                        subGoalDiv.className = 'ml-4 mb-4 p-3 bg-slate-50 rounded-lg border border-slate-200';
                        
                        let tasksHtml = '';
                        if (subGoal.tasks && subGoal.tasks.length > 0) {
                            tasksHtml = '<div class="ml-6 mt-3 space-y-2">';
                            subGoal.tasks.forEach(task => {
                                tasksHtml += `
                                    <div class="flex items-center p-2.5 bg-white rounded-md shadow-sm border border-slate-100">
                                        <input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3 flex-shrink-0" id="view-${task.id}" ${task.completed ? 'checked' : ''} disabled>
                                        <div class="flex-1 min-w-0">
                                            <label for="view-${task.id}" class="text-sm text-slate-800 font-medium">${task.description}</label>
                                            <p class="text-xs text-slate-500">Status: ${task.status || 'N/A'} | Priority: ${task.priority || 'N/A'} | Owner: ${task.owner || 'N/A'}</p>
                                        </div>
                                    </div>
                                `;
                            });
                            tasksHtml += '</div>';
                        }

                        subGoalDiv.innerHTML = `
                            <div class="flex justify-between items-center">
                                <h4 class="text-md font-medium text-slate-700">${subGoal.description}</h4>
                                <span class="text-xs text-slate-500">Status: ${subGoal.status || 'N/A'}</span>
                            </div>
                            <p class="text-xs text-slate-600 mt-1">Target: ${subGoal.target || 'N/A'}</p>
                            ${tasksHtml} 
                            <div class="mt-3">
                                <button class="manageSubGoalTasksButton px-3 py-1.5 text-xs font-medium text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex items-center" data-subgoal-id="${subGoal.id}" data-parent-goal-id="${goal.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1.5">
                                        <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                                    </svg>
                                    Add Tasks
                                </button>
                            </div>
                        `;
                        breakdownContainer.appendChild(subGoalDiv);
                    });
                } else {
                    breakdownContainer.innerHTML = '<p class="text-sm text-slate-500">No sub-goals or tasks defined for this goal.</p>';
                }
            }
        }

        // Function to populate the Goal Edit View
        function populateGoalEditView(goalId) {
            currentEditingGoalId = goalId; // Set the ID of the goal being edited
            const goal = goalsData[goalId];
            if (goal) {
                document.getElementById('editGoalId').value = goal.id;
                document.getElementById('editGoalDescription').value = goal.description;
                document.getElementById('editGoalLifecycleStatus').value = goal.lifecycleStatus;
                document.getElementById('editGoalCategory').value = goal.category;
                document.getElementById('editGoalStartDate').value = goal.startDate;
                document.getElementById('editGoalTargetMeasure').value = goal.targetMeasure;
                document.getElementById('editGoalTargetDetailValue').value = goal.targetDetailValue;
                document.getElementById('editGoalTargetDueDate').value = goal.targetDueDate || '';
                document.getElementById('editGoalNotes').value = goal.notes || '';

                // Deep copy subGoals to tempSubGoals for editing
                tempSubGoals = goal.subGoals ? JSON.parse(JSON.stringify(goal.subGoals)) : [];
                renderSubGoalsInForm(tempSubGoals, editSubGoalsDisplayContainer, true, goalId);
            }
        }
        
        // Event Listeners for Navigation to Sub-Goal/Task Forms
        if (navigateToSubGoalFormButton) { 
            navigateToSubGoalFormButton.addEventListener('click', () => {
                // currentParentGoalForSubGoal = 'temp_main_goal'; // Indicates a new main goal is being created
                window.location.hash = '#add-sub-goal?from=goalCreation'; 
            });
        }
        if (navigateToSubGoalFormButtonFromEdit) {
            navigateToSubGoalFormButtonFromEdit.addEventListener('click', () => {
                window.location.hash = `#add-sub-goal?from=goalEdit&parentGoalId=${currentEditingGoalId}`;
            });
        }
         if (addSubGoalToDetailViewButton) { 
            addSubGoalToDetailViewButton.addEventListener('click', () => {
                window.location.hash = `#add-sub-goal?parentGoalId=${currentViewingGoalId}&from=goalDetail`;
            });
        }

        if (navigateToTaskFormButton) { 
             navigateToTaskFormButton.addEventListener('click', () => {
                // Determine parent IDs from the current hash for context
                const params = new URLSearchParams(window.location.hash.split('?')[1]);
                const parentGoalId = params.get('parentGoalId');
                const fromView = params.get('from');
                // currentParentSubGoalForTask = 'temp_sub_goal'; // Indicates a new sub-goal is being created
                let taskNavHash = '#add-task?from=subGoalCreation';
                if (parentGoalId) taskNavHash += `&parentGoalId=${parentGoalId}`;
                if (fromView) taskNavHash += `&returnFrom=${fromView}`; // To know where sub-goal creation was initiated
                window.location.hash = taskNavHash;
            });
        }
        
        // Event Listener for "Add Tasks" button within Goal Detail's Sub-Goal list
        document.getElementById('viewGoalBreakdownContainer')?.addEventListener('click', function(event) {
            const target = event.target.closest('button.manageSubGoalTasksButton'); 
            if (target) {
                const subGoalId = target.dataset.subgoalId;
                const parentGoalId = target.dataset.parentGoalId;
                // currentParentSubGoalForTask = subGoalId; 
                window.location.hash = `#add-task?parentSubGoalId=${subGoalId}&parentGoalId=${parentGoalId}&from=goalDetail`;
            }
        });

        // Event Listener for Task Search within Add Sub-Goal View
        if (taskSearchButtonSubGoal) { 
            taskSearchButtonSubGoal.addEventListener('click', () => {
                const searchTerm = taskSearchInputSubGoal.value.toLowerCase();
                taskSearchResultsContainerSubGoal.innerHTML = ''; 
                if (!searchTerm) return;

                const results = existingTasksData.filter(task => task.description.toLowerCase().includes(searchTerm));
                if (results.length > 0) {
                    results.forEach(task => {
                        const taskDiv = document.createElement('div');
                        taskDiv.className = 'p-2 border rounded-md hover:bg-indigo-50 cursor-pointer text-sm';
                        taskDiv.textContent = `${task.description} (Owner: ${task.owner})`;
                        taskDiv.dataset.taskId = task.id;
                        taskDiv.addEventListener('click', () => linkExistingTaskToTempSubGoal(task)); 
                        taskSearchResultsContainerSubGoal.appendChild(taskDiv);
                    });
                } else {
                    taskSearchResultsContainerSubGoal.innerHTML = '<p class="text-xs text-slate-500">No tasks found.</p>';
                }
            });
        }

        // Function to link an existing task to the temporary sub-goal being created
        function linkExistingTaskToTempSubGoal(taskData) { 
            if (tempTasksForSubGoal.find(t => t.id === taskData.id)) {
                console.warn("This task is already linked to the sub-goal.");
                const existingItem = tasksForSubGoalContainer.querySelector(`[data-task-id="${taskData.id}"]`);
                if (existingItem) {
                    existingItem.classList.add('bg-yellow-100', 'border-yellow-400');
                    setTimeout(() => existingItem.classList.remove('bg-yellow-100', 'border-yellow-400'), 1500);
                }
                return;
            }
            tempTasksForSubGoal.push({...taskData, isExisting: true }); 
            
            renderTasksInSubGoalForm(); // Re-render tasks in the sub-goal form
            taskSearchResultsContainerSubGoal.innerHTML = ''; 
            taskSearchInputSubGoal.value = '';
        }
        
        // Function to render tasks in the Add Sub-Goal form
        function renderTasksInSubGoalForm() {
            tasksForSubGoalContainer.innerHTML = '';
            tempTasksForSubGoal.forEach((task, index) => {
                const taskDisplayItem = document.createElement('div');
                taskDisplayItem.className = 'p-1.5 border rounded-md bg-blue-50 text-xs ml-4 flex justify-between items-center';
                taskDisplayItem.dataset.taskId = task.id;
                taskDisplayItem.innerHTML = `
                    <span>${task.isExisting ? 'Linked Task: ' : 'New Task: '} ${task.description}</span>
                    <button type="button" class="unlinkOrRemoveTaskButton text-red-500 hover:text-red-700 text-xs" data-index="${index}">
                        ${task.isExisting ? 'Unlink' : 'Remove'}
                    </button>
                `;
                tasksForSubGoalContainer.appendChild(taskDisplayItem);
            });

            // Add event listeners for unlink/remove buttons
            tasksForSubGoalContainer.querySelectorAll('.unlinkOrRemoveTaskButton').forEach(button => {
                button.addEventListener('click', function() {
                    const indexToRemove = parseInt(this.dataset.index);
                    tempTasksForSubGoal.splice(indexToRemove, 1);
                    renderTasksInSubGoalForm(); // Re-render
                });
            });
        }


        // Event Listener for Unlinking/Removing Tasks in Add Sub-Goal View (delegated)
        tasksForSubGoalContainer.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('unlinkOrRemoveTaskButton')) { // Changed class name
                const taskIndexToRemove = parseInt(event.target.dataset.index); // Use index now
                tempTasksForSubGoal.splice(taskIndexToRemove, 1); // Remove task from temp array by index
                renderTasksInSubGoalForm(); // Re-render the list
            }
        });
        
        // Event Listener for Task Search within Task Management Tab (Link Existing)
        if (taskManagementSearchButton) {
            taskManagementSearchButton.addEventListener('click', () => {
                const searchTerm = taskManagementSearchInput.value.toLowerCase();
                taskManagementSearchResults.innerHTML = '';
                
                if (!searchTerm.trim()) {
                    taskManagementSearchResults.innerHTML = '<p class="text-sm text-slate-500">Please enter a search term.</p>';
                    return;
                }

                const results = existingTasksData.filter(task => task.description.toLowerCase().includes(searchTerm));
                if (results.length > 0) {
                    results.forEach(task => {
                        const taskDiv = document.createElement('div');
                        taskDiv.className = 'p-2 border rounded-md hover:bg-indigo-50 cursor-pointer text-sm flex justify-between items-center';
                        taskDiv.innerHTML = `<span>${task.description} (Owner: ${task.owner})</span>
                                           <button class="linkThisTaskButtonDetailView px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600" data-task-id="${task.id}">Link</button>`;
                        
                        taskDiv.querySelector('.linkThisTaskButtonDetailView').addEventListener('click', () => {
                            const params = new URLSearchParams(window.location.hash.split('?')[1]);
                            const parentSubGoalId = params.get('parentSubGoalId');
                            const parentGoalId = params.get('parentGoalId');
                            linkExistingTaskToSubGoalInDetail(task, parentSubGoalId, parentGoalId);
                        });
                        taskManagementSearchResults.appendChild(taskDiv);
                    });
                } else {
                    taskManagementSearchResults.innerHTML = '<p class="text-sm text-slate-500">No existing tasks found matching your search.</p>';
                }
            });
        }
        
        // Function to link an existing task to a sub-goal when in the Goal Detail context (or task management from there)
        function linkExistingTaskToSubGoalInDetail(taskData, subGoalId, parentGoalId) {
            const goal = goalsData[parentGoalId];
            if (goal && goal.subGoals) {
                const subGoal = goal.subGoals.find(sg => sg.id === subGoalId);
                if (subGoal) {
                    if (!subGoal.tasks) subGoal.tasks = [];
                    if (subGoal.tasks.find(t => t.id === taskData.id)) {
                        console.warn("This task is already linked to this sub-goal.");
                        alert("This task is already linked to this sub-goal.");
                        return;
                    }
                    subGoal.tasks.push({...taskData, isExisting: true}); // Mark as existing
                    console.log(`Task ${taskData.description} linked to sub-goal ${subGoal.description}`);
                    window.location.hash = `#view-goal-${parentGoalId}`; 
                } else {
                    console.error("Sub-goal not found for linking task:", subGoalId);
                    alert("Error: Sub-goal not found. Cannot link task.");
                }
            } else {
                 console.error("Parent goal not found for linking task:", parentGoalId);
                 alert("Error: Parent goal not found. Cannot link task.");
            }
        }

        // Core View Switching Logic
        function showView(viewName, params = {}) {
            // Hide all main views
            [dashboardView, orderCreationView, conditionCreationView, goalCreationView, goalDetailView, goalEditView, addSubGoalView, addTaskView].forEach(view => {
                if (view) view.classList.add('view-hidden');
            });
            
            // Show the requested view
            let targetView;
            switch(viewName) {
                case 'orderCreation':
                    targetView = orderCreationView;
                    if(targetView) document.getElementById('createOrderForm').reset();
                    break;
                case 'conditionCreation':
                    targetView = conditionCreationView;
                    if(targetView) document.getElementById('createConditionForm').reset();
                    break;
                case 'goalCreation':
                    targetView = goalCreationView;
                    if(targetView) {
                        document.getElementById('createGoalForm').reset();
                        tempSubGoals = [];
                        if(subGoalsDisplayContainer) renderSubGoalsInForm(tempSubGoals, subGoalsDisplayContainer, false);
                    }
                    break;
                case 'goalDetail':
                    targetView = goalDetailView;
                    if(targetView) populateGoalDetailView(params.goalId);
                    break;
                case 'goalEdit':
                    targetView = goalEditView;
                    if(targetView) populateGoalEditView(params.goalId);
                    break;
                case 'addSubGoal':
                    targetView = addSubGoalView;
                    if(targetView) {
                        document.getElementById('createSubGoalForm').reset();
                        tempTasksForSubGoal = [];
                        if(tasksForSubGoalContainer) renderTasksInSubGoalForm(); // Clear and render empty
                        if(taskSearchResultsContainerSubGoal) taskSearchResultsContainerSubGoal.innerHTML = ''; 
                        if(taskSearchInputSubGoal) taskSearchInputSubGoal.value = '';
                        
                        // Set return path for cancel/save
                        let returnTo = '#add-goal'; // Default for new goal creation
                        if (params.from === 'goalDetail') {
                            returnTo = `#view-goal-${params.parentGoalId}`;
                        } else if (params.from === 'goalEdit') {
                            returnTo = `#edit-goal-${params.parentGoalId}`;
                        }
                        addSubGoalView.dataset.returnTo = returnTo;
                        addSubGoalView.dataset.parentGoalId = params.parentGoalId || 'temp_main_goal';
                        addSubGoalView.dataset.fromContext = params.from; // 'goalCreation', 'goalEdit', 'goalDetail'
                    }
                    break;
                case 'addTask':
                    targetView = addTaskView;
                    if(targetView) {
                        document.getElementById('createTaskForm').reset();
                        if(params.description) document.getElementById('taskDescription').value = params.description;
                        
                        let returnTo = '#dashboard'; // Default
                        if (params.from === 'goalDetail') { // Coming from "Add Task" on a sub-goal in Goal Detail
                            returnTo = `#view-goal-${params.parentGoalId}`;
                        } else if (params.from === 'subGoalCreation') { // Coming from "Add Task" in Sub-Goal Creation form
                            // Construct the return path to sub-goal form, preserving its original context
                            returnTo = `#add-sub-goal?from=${params.returnFrom || 'goalCreation'}`;
                            if(params.parentGoalId) returnTo += `&parentGoalId=${params.parentGoalId}`;
                        }
                        addTaskView.dataset.returnTo = returnTo;
                        addTaskView.dataset.parentGoalId = params.parentGoalId;
                        addTaskView.dataset.parentSubGoalId = params.parentSubGoalId;
                        addTaskView.dataset.fromContext = params.from;


                        // Default to 'create-task' tab
                        if(createTaskFormSection) createTaskFormSection.classList.remove('view-hidden');
                        if(linkTaskFormSection) linkTaskFormSection.classList.add('view-hidden');
                        if(taskFormTabs) {
                            taskFormTabs.querySelector('[data-tab="create-task"]')?.classList.add('active');
                            taskFormTabs.querySelector('[data-tab="link-task"]')?.classList.remove('active');
                        }
                        if(taskManagementSearchResults) taskManagementSearchResults.innerHTML = '';
                        if(taskManagementSearchInput) taskManagementSearchInput.value = '';
                    }
                    break;
                default:
                    targetView = dashboardView;
            }

            if (targetView) {
                targetView.classList.remove('view-hidden');
            } else {
                if(dashboardView) dashboardView.classList.remove('view-hidden'); // Fallback
            }
            
            // Scroll to top
            setTimeout(() => {
                if (contentWrapper) contentWrapper.scrollTop = 0;
                document.documentElement.scrollTop = 0; 
                document.body.scrollTop = 0; 
                window.scrollTo(0,0); 
            }, 0); 
        }

        // Routing Logic
        function routeHandler() {
            const hash = window.location.hash;
            const [path, queryString] = hash.split('?');
            const params = new URLSearchParams(queryString);

            if (path.startsWith('#view-goal-')) {
                const goalId = path.substring('#view-goal-'.length);
                showView('goalDetail', { goalId });
            } else if (path.startsWith('#edit-goal-')) {
                const goalId = path.substring('#edit-goal-'.length);
                showView('goalEdit', { goalId });
            } else if (path === '#create-order') {
                showView('orderCreation');
            } else if (path === '#add-condition') {
                showView('conditionCreation');
            } else if (path === '#add-goal') {
                showView('goalCreation');
            } else if (path === '#add-sub-goal') {
                showView('addSubGoal', { 
                    parentGoalId: params.get('parentGoalId'), 
                    from: params.get('from') 
                });
            } else if (path === '#add-task') { 
                 showView('addTask', { 
                    parentSubGoalId: params.get('parentSubGoalId'), 
                    parentGoalId: params.get('parentGoalId'), 
                    from: params.get('from'), // e.g. 'subGoalCreation', 'goalDetail'
                    description: params.get('description'),
                    returnFrom: params.get('returnFrom') // Used when task is from sub-goal, to know sub-goal's original 'from'
                });
            }
             else {
                showView('dashboard'); // Default route
            }
        }

        // Event Listeners for "Add" and "Edit" buttons
        if (addOrderBtn) addOrderBtn.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#create-order'; });
        if (addConditionBtn) addConditionBtn.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#add-condition'; });
        if (addGoalBtn) addGoalBtn.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#add-goal'; });
        if (editGoalButtonOnDetailView) {
            editGoalButtonOnDetailView.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentViewingGoalId) {
                    window.location.hash = `#edit-goal-${currentViewingGoalId}`;
                }
            });
        }


        // Navigation Helper Functions
        function goBackToDashboard() { window.location.hash = '#dashboard'; }
        function goBackToGoalDetail(goalId) { window.location.hash = `#view-goal-${goalId || currentViewingGoalId || currentEditingGoalId}`; }

        // Event Listeners for Back/Cancel Buttons
        if (backToDashboardFromOrderBtn) backToDashboardFromOrderBtn.addEventListener('click', goBackToDashboard);
        if (cancelOrderBtn) cancelOrderBtn.addEventListener('click', goBackToDashboard);
        if (backToDashboardFromConditionBtn) backToDashboardFromConditionBtn.addEventListener('click', goBackToDashboard);
        if (cancelConditionBtn) cancelConditionBtn.addEventListener('click', goBackToDashboard);
        
        // Goal Creation
        if (backToDashboardFromGoalBtn) backToDashboardFromGoalBtn.addEventListener('click', goBackToDashboard);
        if (cancelGoalBtn) cancelGoalBtn.addEventListener('click', goBackToDashboard);
        
        // Goal Detail
        if (backToDashboardFromGoalDetailBtn) backToDashboardFromGoalDetailBtn.addEventListener('click', goBackToDashboard);

        // Goal Edit
        if (backToGoalDetailFromEditBtn) backToGoalDetailFromEditBtn.addEventListener('click', () => goBackToGoalDetail(currentEditingGoalId));
        if (cancelGoalEditBtn) cancelGoalEditBtn.addEventListener('click', () => goBackToGoalDetail(currentEditingGoalId));
        
        // Sub-Goal Creation/Editing
        if(backToParentFromSubGoalBtn) {
            backToParentFromSubGoalBtn.addEventListener('click', () => {
                const returnPath = addSubGoalView.dataset.returnTo || '#add-goal';
                window.location.hash = returnPath;
            });
        }
        if(cancelSubGoalBtn) {
            cancelSubGoalBtn.addEventListener('click', () => {
                const returnPath = addSubGoalView.dataset.returnTo || '#add-goal';
                window.location.hash = returnPath;
            });
        }

        // Task Creation/Linking
        if(backToParentFromTaskBtn) {
            backToParentFromTaskBtn.addEventListener('click', () => {
                const returnPath = addTaskView.dataset.returnTo || '#dashboard';
                window.location.hash = returnPath;
            });
        }
        if(cancelTaskBtn) {
            cancelTaskBtn.addEventListener('click', () => {
                const returnPath = addTaskView.dataset.returnTo || '#dashboard';
                window.location.hash = returnPath;
            });
        }
        
        
        // Form Submission Handlers
        document.getElementById('createGoalForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const goalDesc = document.getElementById('goalDescription').value;
            const newGoalId = goalDesc.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
            goalsData[newGoalId] = {
                id: newGoalId,
                description: goalDesc,
                lifecycleStatus: document.getElementById('goalLifecycleStatus').value,
                category: document.getElementById('goalCategory').value,
                startDate: document.getElementById('goalStartDate').value,
                targetMeasure: document.getElementById('goalTargetMeasure').value,
                targetDetailValue: document.getElementById('goalTargetDetailValue').value,
                targetDueDate: document.getElementById('goalTargetDueDate').value,
                notes: document.getElementById('goalNotes').value,
                subGoals: [...tempSubGoals] // Use the collected sub-goals
            };
            console.log("Main Goal Created:", goalsData[newGoalId]);
            tempSubGoals = []; // Reset for next creation
            goBackToDashboard(); // Or go to detail view: goBackToGoalDetail(newGoalId);
        });

        document.getElementById('editGoalForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const goalIdToEdit = document.getElementById('editGoalId').value;
            if (goalsData[goalIdToEdit]) {
                goalsData[goalIdToEdit] = {
                    ...goalsData[goalIdToEdit], // Preserve existing fields like ID
                    description: document.getElementById('editGoalDescription').value,
                    lifecycleStatus: document.getElementById('editGoalLifecycleStatus').value,
                    category: document.getElementById('editGoalCategory').value,
                    startDate: document.getElementById('editGoalStartDate').value,
                    targetMeasure: document.getElementById('editGoalTargetMeasure').value,
                    targetDetailValue: document.getElementById('editGoalTargetDetailValue').value,
                    targetDueDate: document.getElementById('editGoalTargetDueDate').value,
                    notes: document.getElementById('editGoalNotes').value,
                    subGoals: [...tempSubGoals] // Use the potentially modified sub-goals
                };
                console.log("Goal Updated:", goalsData[goalIdToEdit]);
                tempSubGoals = []; // Reset
                currentEditingGoalId = null;
                goBackToGoalDetail(goalIdToEdit);
            } else {
                console.error("Goal ID not found for editing:", goalIdToEdit);
                alert("Error: Could not save changes. Goal not found.");
            }
        });

        document.getElementById('createSubGoalForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const subGoalDesc = document.getElementById('subGoalDescription').value;
            const subGoalTarget = document.getElementById('subGoalTarget').value;
            const newSubGoal = {
                id: `sg-${Date.now()}`, 
                description: subGoalDesc, 
                target: subGoalTarget, 
                tasks: [...tempTasksForSubGoal], // Use collected tasks
                status: 'Planned' // Default status
            };
            
            const parentGoalId = addSubGoalView.dataset.parentGoalId;
            const fromContext = addSubGoalView.dataset.fromContext; // 'goalCreation', 'goalEdit', 'goalDetail'

            if (fromContext === 'goalCreation') { // Adding to a new main goal being created
                tempSubGoals.push(newSubGoal);
                renderSubGoalsInForm(tempSubGoals, subGoalsDisplayContainer, false);
            } else if (fromContext === 'goalEdit' && parentGoalId) { // Adding to an existing main goal being edited
                tempSubGoals.push(newSubGoal); // Add to the temporary list for the edit view
                renderSubGoalsInForm(tempSubGoals, editSubGoalsDisplayContainer, true, parentGoalId);
            } else if (fromContext === 'goalDetail' && parentGoalId && goalsData[parentGoalId]) { // Adding directly to a persisted goal
                if (!goalsData[parentGoalId].subGoals) goalsData[parentGoalId].subGoals = [];
                goalsData[parentGoalId].subGoals.push(newSubGoal);
            } else {
                console.error("Cannot determine where to save sub-goal. ParentGoalId:", parentGoalId, "FromContext:", fromContext);
                alert("Error: Could not save sub-goal. Context unclear.");
                return; // Prevent further execution if context is bad
            }
            
            tempTasksForSubGoal = []; // Reset for next sub-goal or task
            console.log("Sub-Goal Saved:", newSubGoal, "to parent context:", fromContext, "parentGoalId:", parentGoalId);
            window.location.hash = addSubGoalView.dataset.returnTo || '#dashboard'; // Navigate back
        });

         document.getElementById('createTaskForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const taskDesc = document.getElementById('taskDescription').value;
            const newTask = {
                id: `task-${Date.now()}`, 
                description: taskDesc, 
                completed: false, 
                status: document.getElementById('taskStatus').value, 
                priority: document.getElementById('taskPriority').value, 
                owner: document.getElementById('taskOwner').value,
                startDate: document.getElementById('taskStartDate').value,
                endDate: document.getElementById('taskEndDate').value,
                notes: document.getElementById('taskNotes').value,
                isExisting: false // Mark as new
            };
            
            const parentSubGoalId = addTaskView.dataset.parentSubGoalId; // Might be 'temp_sub_goal' or an actual ID
            const parentGoalId = addTaskView.dataset.parentGoalId;
            const fromContext = addTaskView.dataset.fromContext; // 'subGoalCreation', 'goalDetail'

            if(fromContext === 'subGoalCreation'){ 
                tempTasksForSubGoal.push(newTask);
                renderTasksInSubGoalForm(); // Re-render tasks in the sub-goal form
            } else if (fromContext === 'goalDetail' && parentGoalId && parentSubGoalId) { 
                const mainGoal = goalsData[parentGoalId];
                if(mainGoal && mainGoal.subGoals){
                    const subGoal = mainGoal.subGoals.find(sg => sg.id === parentSubGoalId);
                    if(subGoal){
                        if(!subGoal.tasks) subGoal.tasks = [];
                        subGoal.tasks.push(newTask);
                        console.log(`New task added to sub-goal ${subGoal.description} in main goal ${mainGoal.description}`);
                    } else {
                        console.error("Parent sub-goal not found in goalDetail context for task:", parentSubGoalId);
                        alert("Error: Could not add task. Parent sub-goal not found.");
                    }
                } else {
                    console.error("Parent goal or sub-goals not found in goalDetail context for task:", parentGoalId);
                    alert("Error: Could not add task. Parent goal not found.");
                }
            } else {
                 console.error("Cannot determine where to save task. Context:", fromContext, "SubGoalId:", parentSubGoalId, "GoalId:", parentGoalId);
                 alert("Error: Could not save task. Context unclear.");
                 return;
            }
            console.log("Task Form Submitted:", newTask);
            window.location.hash = addTaskView.dataset.returnTo || '#dashboard'; // Navigate back
        });
        
        
        // Initialize routing and drawer
        window.addEventListener('load', () => {
            routeHandler();
            if (window.innerWidth >= 1024) openDrawer(); else closeDrawer();
        });
        window.addEventListener('hashchange', routeHandler);

        // Drawer Open/Close Logic
        function openDrawer() {
            if (patientDrawer) {
                patientDrawer.classList.remove('-translate-x-full');
                patientDrawer.classList.add('translate-x-0');
                if (contentWrapper) contentWrapper.classList.add('lg:ml-80'); 
            }
            if(drawerOverlay && window.innerWidth < 1024) { 
                drawerOverlay.classList.remove('hidden');
            }
             if (window.innerWidth < 1024) { 
                document.body.style.overflow = 'hidden';
            }
        }

        function closeDrawer() {
            if (patientDrawer) {
                patientDrawer.classList.remove('translate-x-0');
                patientDrawer.classList.add('-translate-x-full');
                if(contentWrapper) contentWrapper.classList.remove('lg:ml-80');
            }
             if(drawerOverlay) {
                drawerOverlay.classList.add('hidden');
            }
            document.body.style.overflow = ''; 
        }
        
        if (openDrawerButton) openDrawerButton.addEventListener('click', openDrawer);
        if (closeDrawerButton) closeDrawerButton.addEventListener('click', closeDrawer);
        if (drawerOverlay) drawerOverlay.addEventListener('click', closeDrawer); 

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && patientDrawer && !patientDrawer.classList.contains('-translate-x-full')) {
                closeDrawer();
            }
        });

        // Task Form Tabs
        taskFormTabs?.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const tab = e.target.dataset.tab;
                taskFormTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                if (tab === 'create-task') {
                    if(createTaskFormSection) createTaskFormSection.classList.remove('view-hidden');
                    if(linkTaskFormSection) linkTaskFormSection.classList.add('view-hidden');
                } else if (tab === 'link-task') {
                    if(createTaskFormSection) createTaskFormSection.classList.add('view-hidden');
                    if(linkTaskFormSection) linkTaskFormSection.classList.remove('view-hidden');
                }
            }
        });
    </script>
</body>
</html>
